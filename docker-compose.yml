services:
  servidor-sql:
    image: mcr.microsoft.com/mssql/server:2022-CU12-ubuntu-20.04
    container_name: servidor-sql-ticketmanager
    environment:
      SA_PASSWORD: "${CONTRASENA_SQL}"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    ports:
      - "${PUERTO_SQL}:1433"
    volumes:
      - datos_sqlserver:/var/opt/mssql
    networks:
      - red-ticketmanager
    healthcheck:
      test: [
          "CMD-SHELL",
          "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"${CONTRASENA_SQL}\" -Q 'SELECT 1' || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  rabbitmq:
    image: rabbitmq:3.12.12-management
    container_name: rabbitmq-ticketmanager
    environment:
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_USUARIO}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_CONTRASENA}"
    ports:
      - "${PUERTO_RABBITMQ_AMQP}:5672"
      - "${PUERTO_RABBITMQ_WEB}:15672"
    volumes:
      - datos_rabbitmq:/var/lib/rabbitmq
    networks:
      - red-ticketmanager
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  api-ticketmanager:
    build:
      context: .
      dockerfile: ADR_T.TicketManager.WebAPI/Dockerfile
    container_name: api-ticketmanager
    environment:
      # Configuración Base de Datos
      - ConnectionStrings__DefaultConnection=Server=servidor-sql;Database=ADR_T_Ticket_Development;User Id=sa;Password=${CONTRASENA_SQL};TrustServerCertificate=True;Encrypt=false
      
      # Configuración RabbitMQ
      - RABBITMQ__HOST=rabbitmq
      - RABBITMQ__USERNAME=${RABBITMQ_USUARIO}
      - RABBITMQ__PASSWORD=${RABBITMQ_CONTRASENA}
      - RABBITMQ__VIRTUALHOST=/
      
      # Configuración JWT
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=adr-ticketmanager-api
      - JwtSettings__Audience=ticketmanager-client
      - JwtSettings__ExpirationInMinutes=120
      
      # Configuración Seeding
      - SEEDDATA__DEFAULTPASSWORD=${SEEDDATA_DEFAULTPASSWORD}
      - SEEDDATA__ADMINPASSWORD=${SEEDDATA_ADMINPASSWORD}
      
      # Configuración CORS para Angular en Docker
      - CorsSettings__AdditionalOrigins__0=http://host.docker.internal:4200
      
      # Entorno ASP.NET
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    ports:
      - "${PUERTO_API}:80"
    depends_on:
      servidor-sql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - red-ticketmanager
    restart: unless-stopped

  servicio-notificaciones:
    build:
      context: .
      dockerfile: ADR_T.NotificationService.API/Dockerfile
    container_name: servicio-notificaciones
    environment:
      # Configuración Base de Datos
      - CONNECTION_STRING_NOTIFICATION=Server=servidor-sql;Database=ADR_T_NotificationDb_dev;User Id=sa;Password=${CONTRASENA_SQL};TrustServerCertificate=True;Encrypt=false
      - ConnectionStrings__NotificationConnection=Server=servidor-sql;Database=ADR_T_NotificationDb_dev;User Id=sa;Password=${CONTRASENA_SQL};TrustServerCertificate=True;Encrypt=false
      
      # Configuración RabbitMQ
      - RABBITMQ__HOST=rabbitmq
      - RABBITMQ__USERNAME=${RABBITMQ_USUARIO}
      - RABBITMQ__PASSWORD=${RABBITMQ_CONTRASENA}
      - RABBITMQ__VIRTUALHOST=/
      
      # Entorno ASP.NET
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    ports:
      - "${PUERTO_NOTIFICACIONES}:80"
    depends_on:
      servidor-sql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - red-ticketmanager
    restart: unless-stopped

volumes:
  datos_sqlserver:
    driver: local
  datos_rabbitmq:
    driver: local

networks:
  red-ticketmanager:
    driver: bridge