name: Continuous Integration - Quality Gate

# Permisos m铆nimos requeridos para leer c贸digo y escribir eventos de seguridad/artefactos
permissions:
  contents: read
  security-events: write

on:
  push:
    branches:
      - main 
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Construcci贸n, Pruebas y Cobertura (Quality Gate)
    runs-on: ubuntu-latest
    timeout-minutes: 15 
    
    env:
      ConnectionStrings__DefaultConnection: Server=localhost;Database=ticket_manager_test;Trusted_Connection=false;MultipleActiveResultSets=true
      JWT__Secret: test_jwt_secret_key_min_32_chars_1234567890
      ASPNETCORE_ENVIRONMENT: Testing
      LOGGING__LEVEL: Warning 
      DOTNET_VERSION: '9.0.x'

    steps:
      - name: 1. Checkout del C贸digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: 2. Configurar Caching de NuGet ( ADOPCIN AVANZADA)
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 3. Configurar .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 4. Restaurar Dependencias (NuGet y Local Tools)
        # Esto restaura packages y luego las herramientas locales (ReportGenerator)
        run: |
          dotnet restore 
          dotnet tool restore

      - name: 5. Construir Soluci贸n
        run: dotnet build --configuration Release --no-restore

      - name: 6. Ejecutar Pruebas y Cobertura (Quality Gate Check)
        # Ejecuta las pruebas y Coverlet. El fallo de umbral ser谩 gestionado por el resultado del comando.
        run: |
          dotnet test ADR_T.TicketManager.Tests/ADR_T.TicketManager.Tests.csproj \
            --configuration Release \
            --no-build \
            --settings solution.runsettings \
            --collect:"XPlat Code Coverage;Format=cobertura" \
            --results-directory TestResults \
            --logger "console;verbosity=normal"

      - name: 7. Generar Reporte HTML (Usando dotnet tool run)
        run: |
          COBERTURA_FILE=$(find TestResults -name "coverage.cobertura.xml" | head -n 1)
          
          dotnet tool run reportgenerator -- \
            -reports:$COBERTURA_FILE \
            -targetdir:coverage_report \
            -reporttypes:Html

      - name: 8. Publicar Proyecto (Preparaci贸n para CD)
        run: dotnet publish --configuration Release --output ./publish --no-build

      - name: 9. Subir Artefacto de Cobertura
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: coverage_report

      - name: 10. Subir Artefacto de la Aplicaci贸n
        # Este artefacto se usar谩 si se implementa un job de despliegue posterior (CD)
        uses: actions/upload-artifact@v4
        with:
          name: net-app-publish
          path: ./publish